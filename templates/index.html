<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiBrowserTool Interaction Test - {{ identifier.number }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="border-overlay" style="border-color: {{ identifier.color }};"></div>
    <div class="instance-id" style="color: {{ identifier.color }};">{{ identifier.number }}</div>
    <h1>MultiBrowserTool Interaction Test</h1>

    <div id="ui-area">
        {% for el in elements %}
        <div class="element-container">
            {% if el.type == 'button' %}
            <button id="{{ el.id }}">{{ el.label }}</button>
            {% elif el.type == 'checkbox' %}
            <label for="{{ el.id }}">{{ el.label }}</label>
            <input type="checkbox" id="{{ el.id }}">
            {% elif el.type == 'textbox' %}
            <label for="{{ el.id }}">{{ el.label }}</label>
            <input type="text" id="{{ el.id }}">
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <h3>Interaction Log</h3>
    <div id="console" class="log-container"></div>

    <script>
        const logContainer = document.getElementById('console');

        function appendLog(text) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = text;
            logContainer.insertBefore(div, logContainer.firstChild); // Prepend for newest top
        }

        async function logAction(elementId, actionType, value = null) {
            // Local fallback time immediate feedback
            // appendLog(`[PENDING] ${elementId} ${actionType}...`);

            try {
                const response = await fetch('/log_action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: elementId,
                        action: actionType,
                        value: value,
                        client_time: Date.now() / 1000 // Send seconds timestamp
                    })
                });
                const data = await response.json();
                appendLog(`[${data.server_time}] ID: ${data.id}, Action: ${data.action}` + (data.value ? `, Value: ${data.value}` : ''));
            } catch (e) {
                appendLog(`[ERROR] Failed to log interaction for ${elementId}`);
            }
        }

        // Attach listeners
        {% for el in elements %}
        {% if el.type == 'button' %}
        document.getElementById("{{ el.id }}").addEventListener('click', () => logAction("{{ el.id }}", "click"));
        {% elif el.type == 'checkbox' %}
        document.getElementById("{{ el.id }}").addEventListener('change', (e) => logAction("{{ el.id }}", "change", e.target.checked));
        {% elif el.type == 'textbox' %}
        document.getElementById("{{ el.id }}").addEventListener('input', (e) => logAction("{{ el.id }}", "input", e.target.value));
        {% endif %}
        {% endfor %}
    </script>
</body>

</html>